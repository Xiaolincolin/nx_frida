# -*- encoding: utf-8 -*-
# @ModuleName: m11_encrypt
# @Function:
# @Author:
# @Time: 2025/7/28 16:17
import struct

import hexdump

XX_TEA_KEY = [
    0xD2785EF1,
    0xC4C23330,
    0x25A9C8BA,
    0x3A867E67
]
import zlib


def compress_data(data):
    """压缩数据"""
    if isinstance(data, str):
        data = data.encode('utf-8')
    return zlib.compress(data)


def decompress_data(compressed_data):
    """解压缩数据"""
    return zlib.decompress(compressed_data)


def xx_tea_decrypt(data: bytes) -> bytes:
    key = XX_TEA_KEY
    if len(data) % 4 != 0 or len(data) < 8:
        raise ValueError("Invalid encrypted data length")

    v = list(struct.unpack('<%dI' % (len(data) // 4), data))
    n = len(v)
    delta = 0x9E3779B9  # 注意：这是正确的XXTEA delta值，0x61C88647是其补数
    rounds = 6 + 52 // n
    sum_ = (rounds * delta) & 0xFFFFFFFF

    for _ in range(rounds):
        e = (sum_ >> 2) & 3
        for p in reversed(range(n)):  # 从后向前处理
            if p == 0:
                z = v[-1]  # 处理第一个元素时，z是最后一个元素
            else:
                z = v[p - 1]

            y = v[(p + 1) % n]  # 处理边界情况
            mx = (((z >> 5) ^ (y << 2)) + ((y >> 3) ^ (z << 4))) ^ ((sum_ ^ y) + (key[(p & 3) ^ e] ^ z))
            v[p] = (v[p] - mx) & 0xFFFFFFFF
        sum_ = (sum_ - delta) & 0xFFFFFFFF  # 解密时delta应该是递减

    # 取原始长度
    orig_len = v[-1]
    decrypted = struct.pack('<%dI' % (n - 1), *v[:-1])
    return decrypted[:orig_len]


def xx_tea_encrypt(input_bytes: bytes) -> bytes:
    # 填充：4字节对齐 + 附加原始长度
    key = XX_TEA_KEY
    n = len(input_bytes)
    pad = (4 - (n % 4)) % 4
    padded = input_bytes + b'\x00' * pad
    padded += struct.pack('<I', n)  # 原始长度追加到末尾
    v = list(struct.unpack('<%dI' % (len(padded) // 4), padded))

    # 加密过程
    delta = 0x61C88647  # -0x3C6EF372
    rounds = 6 + 52 // len(v)
    sum_ = 0
    n = len(v)
    z = v[-1]

    for _ in range(rounds):
        sum_ = (sum_ - delta) & 0xFFFFFFFF
        e = (sum_ >> 2) & 3
        for p in range(n - 1):
            y = v[p + 1]
            mx = (((z >> 5) ^ (y << 2)) + ((y >> 3) ^ (z << 4))) ^ ((sum_ ^ y) + (key[(p & 3) ^ e] ^ z))
            v[p] = (v[p] + mx) & 0xFFFFFFFF
            z = v[p]
        y = v[0]
        mx = (((z >> 5) ^ (y << 2)) + ((y >> 3) ^ (z << 4))) ^ ((sum_ ^ y) + (key[((n - 1) & 3) ^ e] ^ z))
        v[-1] = (v[-1] + mx) & 0xFFFFFFFF
        z = v[-1]

    # 输出加密数据
    return struct.pack('<%dI' % n, *v)


def encrypt_main():
    ori_data = "0000013810032c3c4003560b6765745446436f6e666967660b6765745446436f6e6669677d0001010a08000106037265711d000100fd0a0300000198500da28b18000a0608706c6174666f726d160132060776657273696f6e1602393006026c6316104244344645323343333532323532444306076368616e6e656c160631303534393806056170706964160a313130313135323537300603706b671619636f6d2e71712e652e756e696f6e2e64656d6f2e756e696f6e060a706b67566572496e666f1613342e3634302e313531302e3231392c3135313006086170694c6576656c1602333206056272616e641606676f6f676c6506056d6f64656c1607506978656c20342a0c10012c380c480c5c0b362038343433633735346139383134616134613765336534653166356336646631330b8c980ca80c"
    data_bytes = bytes.fromhex(ori_data)
    zlib_bytes = compress_data(data_bytes)
    enc = xx_tea_encrypt(zlib_bytes)
    hexdump.hexdump(enc)


def decrypt_main():
    ori_data = "3ed012d4c3e0d8d9bea5648edfb228ced108b9b0005eada7b053cff49af0ffa630ba6eba4dd996126b47a6bb27644ab8c18102c17585c1c3b0af3f0b8cb6a7fdf0d49333fd8270c95c6ba6f7dc01ab37ed4b22ec98cbdd33f79f2f678ba568f17a0583e2b2dfbf8e0866f992ef8211c7c39436f110f10883a2e71f92a372945b462b4791c37fd5f4ac22950b167fab31a153f461e7460ecf74ee8a4bb45c85fd674290b814e3f96ae3282ba150c9ed2216923ad0dc72b2a5ee88e41bc6607d587209ef5de98d3c2a1ca05a8e4b36a9e3096281bc6ee656d02db176c558a7b8891833f3295aabcd6863a611bb70486340c5b3924788f06f881fcbfc617d5ff0babcb9a1bed888a647b3034856cbe9ff72e67c616aac61ab4abd488b64722b5b7b595663c9030c0b20af6b6dbe41c091fe6541b6b95a0ec75603876be7b49be41a3373b8104db41d1126ddb7e06ef525fe726b840c1c6f134d5d0521a7fbd2312f7287164a39d47f16a7fdef996cdbf1cc7cf829bf23da5fab850c9aace12d83c7028b9596275a0315e61b6cc2debaaf2dfb25a670a08ed5ebf8784650013b3716c07a9933c91d50035197f454536104327b108a039109fcfcddbab93d5a7bad2d5efc80ccd395da413108adcc632e63ea690711ab7144e3c8fb61a8a8d2bf868b5e30f74aec912c94d1ea87e31ced83ddc056fd08e0890171fd617f6dfd25d96e93acd430f0f3b0dfc21bd89de44c9649fe57a126c4abe196a72b947cd5289a6371b156ea238d2dc7b7492af3a5d0568046f76a5305c0cdac320914961051b89f5561ad6704a00d26ef70f6dc28484c2bc94a296d5dcd5e09ef14f0319eb86bb707bec0f1145c9d28c0c9e3afad6fb74bca021ebbc9b979b85b94b12dfcb717642f5307032eed87255109a501588baabbc226e49029363c4c0b14063426db52094997a2addd16b9764a3805fe983cf790a986a48eb5d2fd438acc65a9acfb345cad78ac7d515b95be8114e5cbfbce25c30a12f10ab144a8aaf051db134eaac74b2f4021b76fd83681d91c8d8fd160079243ee6d9a34cf782d60e53f7be33eacffe353f9ecf132cb7120ffb9e712035b79499113f4f1212f712c23d2811e2205676e4cb52bf4892c761eb10bfe521e521f04d235cc186cdc9a0e966725c3ed691a0b56022e4f9dcd5cf84b961b8388a34ef19109d4f77e65ee8114766d0576da9333d3bf2f3a1265b33bd17ab66620960222dcfa53bb3f765e3c8689993361ebd48e6089cb916a9f3885a3cff4cc60884475fd367e8a7ec012b88064d6fd8e446ffe7f60c85432b7410e7f94ee8c5f9e685de1a334c057b6eb7a5e730ae0e7b9d81d7fe793e8c67df081d4649b6c8b521daeac18eba457254668b8abc4c772ece314b146fcb205c48e17a0ff153cfe6b23608c37a8b879e01aba72ca7572bfa8bd2a93b7fee72933e752280b92282fdb4e84e31db803944285a03b3eeb9d42853010aa13df3f72aaee9f23c1b58bd58a2b135edae2ec62161c66a01e341f2d468d2089d378f856002bb3af619a8f2b0caecc040e5fad5beb8a10afaa7c76242bd41d59eb65258a2dbb5a1656686bd5be264e0482e4361ba8ba7f75d0d1dfc88efd7addf201f4c926173350b426ac650815115c1f16dceea6c0b00fecdb15e13dc9dc1d66dbd64ba1e75bc7ee9b050ca5de7efe998027a17b9a4b0756985115ecd26df9dd9c760cba869b02348f78ef3e907738e1ea48dfcbfc3d7b4ff98e3c09b3c5e9adf65f6022dfa363d9528d7a99902222706239955f2e85307095d408817553ab44a0ee23b5669a63e3193d73caca1daefc8ab3d02e0ffe7266b188f7123525d1af838231015d06d14824a619799bdae2f526f288b7d95abae79e054ee4d9616a02f3efa6de73d211ee00be159dca8940040135fc8caa99537c92a3da34cf829ff4c6784a80355f5a8b8615f8ced34930225ffa3ff4a2b8a430dc72b81e32cc51c6772e7ec4de09e9cfdd391629abc033de9764e749d1dc438653401ca61807c0165c68ea14aa631505f3541b8692e11a894ba077b0c81bba99898492a3922ab6d72bde502f4e479e7b73d1610a881d560e5ee6bc644b2d6508fae408f30b5f9057391c38b4886457966c7b711e03e8e75589876a7b249e35efe37082dc53b6f0d5ddf2cf86c79f0d5c67a19d0e2b729821d4a0b6a1c77f75b65a6c4c9dea273838e7f2331b7efcbbc7d3ffc5027f15955dbf0d0da2523a17a2a72c04821e11c0ca03c5f7abb82364e39fcd7877b985be91a4029b4bb8bc250c775bf537922d157dbfc6b326fb224b4df3f48f0f1f8707d8eb674460e0b5f2dc909cc18bb85115944f41e71efdf3073249217cb8a02a090beea6ef9341ef4a217391d405ca525df3a425188275bc4b90c49bc53232abc35ae03e34db2394fb8054e4c9a8a95bfd337f7631a995a654ea1e158e92a7b3abbbfa03b336a49440d3d04e57b2e95490faf6c61cf36db4021e5906b9e1e4b9ad7a45e1b3ed7dc60495ae181c85283ff20929ffae7bd248b5d4e546259b62bf5855a6384a301a911662a160d8aea71a234e835e08ab9122e3d112a742516ad3f82b6f0c54e8b4e515098fe40595ee00dbf9c0db3668746edd80ea17907f1fa9ebc56dafeb79ce8d1a448297d1e5ed727b1fc53809090c1c17d05018df216f6b78d206ca883a7cf1e7eac6c7ed97c944dfd3243edf7ebfdfdc31aee5972ed0b50cfb8ebe921b914f5b70114072c1a163a996fc5749265611881d7977d25abf5b3bad35acee7236de5e9a52d48f21c29a0b7b14a9bc5ae2e639a293f1a6e26c1f43ddb0b48d7a8d636a31c51cc83b24549c465e1c3dc7ad70cc22edcb9cdbee31cc4e0a3106ec905875b2e9af7b06ce672f44e80bdaf956574f16da2ee1b1f24117f41ea233c790014ff92ddac6edb487e18dbcd92a15c2a0fb833da70d4acc9c164fa30a213961f0420339dae78270b4f6a415ae5020721f65cca141b14b39d034a099204a373f5393f9a9ff3fc2be5163e2ef2773621337e29b15a788ebcf47fc2cd8dd89fb6d674473d7374bf2354fcb92eecce8f9392f4fe88eee8b68515f41d75c928c37acd3364a89c6623f69197425166d2dabba1d7101e045a00da44af002cdecb8fd1eb27998f31bbb91c1d7e02a49720ca72aca5404c044a68610d84970df7e7e271137745fbf72c4425075ee5a824ffac37ca79e557d3a110507acdf2fa58979ec2a7daa9b503f36ef78ee4063f314a3244136ac84129b1071c362ae627cc438a4980740f4ea5cb0835416d53fb4470eb4fc4d442bed229b698b3a4b55dafbee80059bc1d03e4920a8fcb12948335b79c41445ef99c7d50bf591b46779f8b7a3f6508c8721e045d4f4cf03616d9a5061a80cc1c9b209461474ed23c6024024cdc91b082eb89c8223ad84cc8b238cb219f5853037b6687a96ed6388bd034c9e005e372c2f399bd3c94405624ebe8d10d95b1be5a690b0a278ad0a780c7881d5b8c535f8c733bdb8ca756a3e2aa42a3062fed519008d29c44a465abb542b8c5177890133a0716f68b7724e98a81620d42de48e6020c180873ae6d9a8df1dfc6f3de494b7a9d6ce654322ea2dec72a4fd992aa777da8cc1ef7b69025b0c06377988fb861e6d9d6f5b94d31a6022f7000c833d5b61b1d42b821dcf4e542215d1e0b28904b4aea4791b573b0ef84c3477f585eed6d8747631c089c46ec0d0b3d38911253ce65625b852b53172f5731873ecb852f897a5ab8bc2b8de3fcf1c3efc9fc2606089e91e80c8fc86e6bd1e07182e52c95f7c4b75e3fff867fc90cd58e823c8d4e804fcd58aa511730a952d28ac48a6dfc9b3c063421d157216b5041c207dad5f96e22789fc1f049a808a3fb477e9c964d4c3ada31b40c0c985ba1a9595f8892edd5f662b6e2911ad9f659c1ced77551f1305798216cd999eafe54f929bfd8231a5a318ac22a64d55fbaf23d739366c401273a9d6ba7f761566690ceb00145d980ec2b84f41acb2c7ac1b5d96224667eb761c9368c2f0e44a6925a1d65a4672df0d7b9e9b4f25f6c2aabb9341d07fb67a6c83e69a0385363819d1651736f2dc6993854ff3e541d0210e4f703dcfe5f08434434135e3f6e80a46d55a3337b850cab3a9cd93b8b0e97f8004566b7eefbdd1bebf26cb1377b2eb3799087b6c53f935eca72c564037adc6749092395d274c46b8b5bba30d272162426e40beacc889a2f3363c0b24ce0acdf2c56cc8a34362788cafe569948ce7984920db8d0d215c866fd901e74cac921e84dc5452192e06a4d3dd46847f1bc3482a38481d10df9239cabef8faa2b6a4cc74eaa72cd74a1acb48d09f6fc8aeb452dd931d69328ac6117097d69c71f723c4d269712a376ca022670be244f52cf03bdf5453f234af676f3fc96c14b976e3b19bce412ea05c6f307d8b58421e04a359c9d85c8eb2f623c294b4c81477af6aca8d0b53f54b00012c57a2e688ec06de29c514204ac7ea161f0a72a22e56f475bc6ffa3df81e946b9369c03e74ab44c807f7753dd30695eea31a0099996caac3ae4c3dde4c3ac0cb2522b82ff524d6328155ac3bd25b93836c0d8289b5c15d2259d0e88838b0e3ee41cac0e3fed304dbc16aaff9e827bc0d81ca0796c1de55fb6e64ee8edba67a65aeba65ac1e5a66773b0cb6d6995adf6445a6ddacba89e1a27ee8b8c191e8d282525ebfa414b898f26ae94ea30d56f282723f3f3f342c3cc41351ce7ae2d8e7839014bb1db646a6c3779cfeff539a87c05d853f77ef453f1cf041cd7287e73c52b429b945fc9a7cd8b51a4fae95fb2abbfa686d36176a4fca5d9ee9ef868b5f3796c9477ed0e17d231c1c81d7e0bdccf9045a6edbdafddd046e5ba1034ded37404b4b7ae798d5138eb3056265b09edb1bd247878a9a101bdf09b32c715badc3712f867c2b21c4df71e59f4fbd04a4a680ea0fbea3368b1c3632ee02f05b36eb419c571ab1ad5f560a7d3a502fd9fc28985be676202e4d124f3e02eec03ef92bbe5723dae97c4b51d72e4f319261760948b27148fb1a0f315891b2722ba07d5d80e4a185ce53fa4f921d23512062d55a9c6a1a4236c4670708473f5a1d32252dfd5d20c45247dbf4f565207837280e3e295a333e2c64bc328e7d06567011dcb99ec8da26f5b512838a7236473be972b9bc8a1a613c7d756c008cd41bca0b60091f1a224221f44e2f6042e729c5a977c78f2fb3d23ed7deab4cc4e5a107d216993433ef07818652b1bb191a859dfb60754da8529cfceb6a639f595be9bef857f68f69eb0cad46da0f3e604777b895d1a33a7c595fc4312d0be9a45898a058f367da941eb38fe97c90efab9f1b4d1859561baf598ec10dd0909b3bbd84c51ee2d22fd9658a4bcd97f306361e7a867b34bc14123aca5e9732dfbaef1993f48b9d7318cc9128fed5a5524ca125693eef5d885d0f5d0c254f075b8ebc7c4c7c5d13baba8ac47be917161934158c89c56f34810a5a876491d50631a4115f991f8fe37ad29136d2e3b9d79be88edf4d915d907a74b341fc648a614b664413841bb5056985f1da07e65bcc6aa088082a1493c7c07942be17f218eba47a2c4901d6bb39a7506b5c57f60eaafa3d981756eb568091d9948761497aa5ec81fa248b22fb940ffd371045dcd1e6e9f8e2bdff9626692ef473f4812d8167add5301f43c56a5efd644a49517a9869b61aa44ac4240fc76a41badc082e4fdfe17ca1b54e1b3559583a0682249ce6e25b788684d71cba074c307fd31060ef70e186813ae4acca32f5231889b58e6bcede799dbb126f38c07b13a51fbedf1e5472abcdf23a6a453c687b8c425507b3f2d7b29cfdfd53c3a658f4f6152be0681b3d448b8754775d167e32629e258e394e535b0d2cee99cc36e907bc8e530828106cb5d243d21f0f76f05705eaac5dd0c9c396d5570ffbfe62f470719a744d4e8b3b4d901894c578b4c7645a0ecb81d2d2691f64019dfd0b6a8e90a73f1d5797320f36408f7a865b3e0fe24d5d66e0bc4d9aa5195ed2a25f4e84281472f3a8fee8c42689cd4cb8cf3d7cf64893"
    data_bytes = bytes.fromhex(ori_data)
    enc_bytes = xx_tea_decrypt(data_bytes)
    un_zlib_bytes = decompress_data(enc_bytes)
    hexdump.hexdump(un_zlib_bytes)


if __name__ == '__main__':
    decrypt_main()
